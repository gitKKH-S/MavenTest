<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="HpFaqMapper">

	<select id="searchFaqCnt" parameterType="java.util.Map" resultType="java.util.Map">
		WITH TB_CNT AS (
			SELECT *  
			FROM TMHP_BOARD
			<where>
				BOARDSEQ = '4' 
				AND NOT DELYN = '1'
					<if test=' SURVYEAR != null and SURVYEAR != "" '>
						AND SURVYEAR = #{SURVYEAR}
					</if>
					<if test=' SURVKINDCD != null and SURVKINDCD != "" '>
						AND SURVKINDCD = #{SURVKINDCD}
					</if>
					<trim prefix="AND(" suffix=")" prefixOverrides="OR">
						<if test=' KEYWORD != null and SUBJECT == "Y" '>
							OR SUBJECT LIKE '%' || #{KEYWORD} || '%'			
						</if>
						<if test=' KEYWORD != null and ANSWER == "Y" '>
							OR ANSWER LIKE '%' || #{KEYWORD} || '%'				
						</if>
						<if test=' KEYWORD != null and WORKERID == "Y" '>
							OR WORKERID LIKE '%' || #{KEYWORD} || '%'			
						</if>
					</trim>				
			</where>
		)
		SELECT COUNT(BOARDSEQ)*2 AS CNT
		FROM TB_CNT	
	</select>
	
	<select id="searchFaqList" parameterType="java.util.Map" resultType="java.util.Map">
	 	WITH BASE AS (
						SELECT 
							'0' AS LV
					 		, A.BOARDSEQ, A.BBSNO, A.BOARDTYPECD, A.SURVYEAR, A.SURVKINDCD, B.CDNM AS SURVKINDNM
					 		, A.REFNO, A.SUBJECT, A.ANSWER||CHR(10)||CHR(13) as ANSWER
					 		, A.NOTICEYN, A.SECRETYN, A.HIT, A.DELYN
							, A.WORKERID, NVL(SP_DEC_FU(COALESCE(A.WORKERNM, C.USERNM)), ' ') as WORKERNM, A.WORKDTHM, A.MODIFIERID, A.MODDTHM
							, A.FILEID
							, CASE 
					            WHEN (SELECT COUNT(ATT_IDT_NO) FROM TMHP_BOARDFILE WHERE ATT_IDT_NO = A.FILEID) > 0 THEN  '1' 
					            ELSE '2' 
					        END AS FILEYN
						FROM TMHP_BOARD A
							LEFT OUTER JOIN (SELECT DISTINCT CD, CDNM
											FROM TCCM_CODE
											WHERE CDTYPE = '0079' AND CD != 'GROUPCD'
										) B ON A.SURVKINDCD = B.CD 
							LEFT OUTER JOIN TMAD_USER C ON A.WORKERID = C.USERID
						<where> 
							A.BOARDSEQ = '4' /* 1.공지사항 ,2.취업통계소식, 3.자료실, 4.FAQ, 5.QnA */
							AND NOT A.DELYN = '1'
							<if test=' SURVYEAR != null and SURVYEAR != "" '>
								AND A.SURVYEAR = #{SURVYEAR}
							</if>
							<if test=' SURVKINDCD != null and SURVKINDCD != "" '>
								AND A.SURVKINDCD = #{SURVKINDCD}
							</if>
							<trim prefix="AND(" suffix=")" prefixOverrides="OR">
								<if test=' KEYWORD != null and SUBJECT == "Y" '>
									OR SUBJECT LIKE '%' || #{KEYWORD} || '%'			
								</if>
								<if test=' KEYWORD != null and ANSWER == "Y" '>
									OR ANSWER LIKE '%' || #{KEYWORD} || '%'				
								</if>
								<if test=' KEYWORD != null and WORKERID == "Y" '>
									OR WORKERID LIKE '%' || #{KEYWORD} || '%'			
								</if>
							</trim>
						</where>
						ORDER by A.WORKDTHM DESC
		) , ANS AS (
	    	SELECT 
	    		'1' AS LV
	    		, A.BOARDSEQ
	            , A.BBSNO, A.BOARDTYPECD, A.SURVYEAR, A.SURVKINDCD, A.SURVKINDNM	            
	            , A.REFNO, A.ANSWER AS SUBJECT, A.ANSWER
	            , A.NOTICEYN, A.SECRETYN, A.HIT, A.DELYN
	            , A.WORKERID, A.WORKERNM, A.WORKDTHM, A.MODIFIERID, A.MODDTHM
	            , NULL AS FILEID, '2' AS FILEYN        
	        FROM BASE A	    
	    ) , FAQ AS (
	    	SELECT * FROM 
		    	(SELECT * FROM BASE
	    			UNION ALL
		    	SELECT * FROM ANS)
	    	ORDER BY BBSNO DESC, LV, WORKDTHM DESC
	
	    )
		SELECT * FROM 
			(
				SELECT ROWNUM as RNUM, T1.* FROM FAQ T1
				
			)
		WHERE RNUM BETWEEN #{START} AND #{END}
			
	</select>
	
	<select id="selectFaqView" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT 
			A.BOARDSEQ, A.BBSNO, A.BOARDTYPECD, A.SURVYEAR, A.SURVKINDCD, A.REFNO
			, A.SUBJECT, A.ANSWER, A.NOTICEYN, A.SECRETYN, A.HIT, A.DELYN
			, A.FILEID
			, A.WORKERID, TO_CHAR(A.WORKDTHM, 'YYYY-MM-DD HH24:MI') AS WORKDTHM, A.MODIFIERID, A.MODDTHM 
			, (SELECT DISTINCT CDNM
							FROM TCCM_CODE
							WHERE CDTYPE = '0079' AND CD != 'GROUPCD'
							AND SURVSEQ = SUBSTR('2020', 3,2)||'1231'
							AND CD = A.SURVKINDCD) AS SURVKINDNM
			, NVL(SP_DEC_FU(COALESCE(A.WORKERNM, B.USERNM)), ' ') as WORKERNM
			, NVL(B.DEPTNM, ' ') AS DEPTNM
		FROM TMHP_BOARD A		
			LEFT OUTER JOIN TMAD_USER B ON A.WORKERID = B.USERID	
		WHERE A.BOARDSEQ = '4'
			AND A.BBSNO = #{BBSNO}	
	</select>
		
	<insert id="insertFaq">
		INSERT INTO TMHP_BOARD (
			BOARDSEQ, BBSNO
			, SURVYEAR, SURVKINDCD
			, SUBJECT, ANSWER
			, WORKERID, FILEID
			, WORKERNM
		) VALUES (
			'4', seq_board.nextval
			, #{SURVYEAR}, #{SURVKINDCD}
			, #{SUBJECT}, #{ANSWER}
			, #{WORKERID}, #{FILEID}
			, SP_ENC_FU(#{WORKERNM})
		)	
	</insert>	
	
	<update id="updateFaq">
		UPDATE TMHP_BOARD
		SET 
		    SURVYEAR    = #{SURVYEAR}, 
		    SURVKINDCD  = #{SURVKINDCD}, 
		    SUBJECT     = #{SUBJECT}, 
		    ANSWER      = #{ANSWER},
		    FILEID		= #{FILEID},
		    MODIFIERID  = #{MODIFIERID},
		    MODDTHM     = SYSDATE
		WHERE BBSNO = #{BBSNO}
			AND BOARDSEQ = '4'
	</update>
	
	<update id="deleteFaq">
		UPDATE TMHP_BOARD
		SET
		    DELYN       = '1', 
		    MODIFIERID  = #{MODIFIERID}, 
		    MODDTHM     = SYSDATE
		WHERE BOARDSEQ    = '4'
			AND BBSNO = #{BBSNO}	
	</update>
	
</mapper>