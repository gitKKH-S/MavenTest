<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="AgEvDocMapper">
	
	<select id="listEvdocInfo" parameterType="java.util.Map" resultType="java.util.Map">
		WITH T_CODE AS (
					SELECT B.SURVSEQ, B.SURVKINDCD, B.CDTYPE, B.CD, B.CDNM	
					FROM TCCM_CODE B
					WHERE SURVSEQ = #{SURVSEQ} AND SURVKINDCD = #{SURVKINDCD}
						AND B.CD != 'GROUPCD' AND B.CDTYPE IN ('1001','1004','0527','0529','2012','6007','2011','2001')
		),BASE AS (	
			SELECT 
				T1.SURVSEQ,T1.SURVKINDCD,T1.SCHKINDCD,T1.SCHCD,T5.SCHNM,T1.ORGCD,T1.COLCD,T1.COLNM
				,T1.DEPTCD,T1.DEPTNM,T1.MOECLASS,T1.DNCD,T1.DETAILDEPTNM,T1.DEGREECD,T1.INYM,T1.OUTYM
				,T1.EXCHANGEYN,T1.STUDENTNO,T1.UNIQUEKEY,T1.BIRTHYEAR,T1.SEXCD,T1.AGE	, SP_DEC_FU(T9.NAME) AS NAME ,T1.JOBTYPECD, T10.JOBTYPECD JOBTYPECD_ORG
				,T1.WELFARECD,T1.CLERICYN,T1.STARTDT,T1.ENDDT,T1.SCHWORKFORM,T1.WORKHOUR,T1.NACODE,T1.FORGCOMNM
				,T1.OVERSEAVISATYPE,T1.OVERSEAVISAYN,T1.OVERSEAWORKTYPE,T1.SAMEUNIVYN,T1.GOSCHCD,T6.SCHNM AS GOSCHNM 
				,T1.GOORGCD,T1.GOFORGSCHNM,T7.JOBTYPEGROUPCD ,T7.JOBTYPEGROUPNM ,T1.ARTNM,T1.ARTPL
				,T1.ARTPO,T1.ALDYEMPLYN,T1.TRANSCLOSEYN,T1.MNTNEMPLYN1,T1.MNTNEMPLYN2,T1.MNTNEMPLYN3,T1.MNTNEMPLYN4
				,T1.TARGETYN,T1.SALARY,T1.INDLGROUPCD,T1.COMTYPE,T1.COMSIZE	,T1.WORKERID,T8.PAGENO
				,T8.IMPROPTYN,T8.RTNRN,T8.EVDDOCETC	,T8.ATT_IDT_NO,T8.ATT_SEQ,T8.SAVE_FILE_NAME
				,case when length(T8.REAL_FILE_NAME)>19 then substr(T8.REAL_FILE_NAME,18,length(T8.REAL_FILE_NAME)) else T8.REAL_FILE_NAME end REAL_FILE_NAME
				,T8.SAVE_PATH,T8.ISEVDDOCYN,T5.SURVPROSTATUSCD,T8.EVDDOCSEQ
				
			FROM TMAG_ATRGRDINFO T1, TMCM_GOSCHOOL T6
				, TMAD_SCHOOL T5,TCCM_JOBCODE T7
				, ( SELECT A.SURVSEQ,A.SURVKINDCD,A.SCHCD,A.ORGCD,A.UNIQUEKEY, A.ATT_IDT_NO,A.ISEVDDOCYN, A.ATT_SEQ
							, B.SAVE_FILE_NAME, B.REAL_FILE_NAME, B.SAVE_PATH  
							,A.PAGENO
							,A.IMPROPTYN
							,A.RTNRN
							,A.EVDDOCETC
							,A.EVDDOCSEQ
					FROM TMAG_EVDDOC A, TMAD_SURVFILE B
					WHERE A.SURVSEQ = #{SURVSEQ}
					AND A.SURVKINDCD = #{SURVKINDCD}					
					AND A.SCHCD = #{SCHCD}
					AND A.ORGCD = #{ORGCD} 
					AND A.EVDDOCSEQ = 1
					AND A.EVDDOCTYPE = '1'
					AND A.ATT_IDT_NO = B.ATT_IDT_NO(+) 
					AND A.ATT_SEQ = B.ATT_SEQ(+)
				) T8, TMGP_GRDPSNINFO T9, TMAG_ATRGRDINFOBF T10
			WHERE
			 	T1.SURVSEQ = #{SURVSEQ}
				AND T1.SURVKINDCD = #{SURVKINDCD}
				AND T1.SCHCD = #{SCHCD}
				AND T1.ORGCD = #{ORGCD}
				AND T1.SURVSEQ = T6.SURVSEQ(+)
				AND T1.SURVKINDCD = T6.SURVKINDCD(+)
				AND T1.GOSCHCD = T6.SCHCD(+)
				AND T1.GOORGCD = T6.ORGCD(+)					
				AND T1.SURVSEQ = T5.SURVSEQ
				AND T1.SURVKINDCD = T5.SURVKINDCD
				AND T1.SCHCD = T5.SCHCD
				AND T1.ORGCD = T5.ORGCD		
				AND T1.SURVSEQ = T7.SURVSEQ(+)
				AND T1.SURVKINDCD = T7.SURVKINDCD(+)		
				AND T1.JOBTYPECD NOT IN ('27','4','80','14','81','16','82','70','71','72','33','35','36')
				AND DECODE(T1.JOBTYPECD,'52','51','4','80','14','81','16','82', T1.JOBTYPECD) = T7.JOBTYPECD(+)
				AND T1.SURVSEQ = T8.SURVSEQ
				AND T1.SURVKINDCD = T8.SURVKINDCD
				AND T1.SCHCD = T8.SCHCD
				AND T1.ORGCD = T8.ORGCD
				AND T1.UNIQUEKEY = T8.UNIQUEKEY
				AND T1.SURVSEQ = T9.SURVSEQ(+)
				AND 'GP' = T9.SURVKINDCD(+) 
				AND T1.SCHCD = T9.SCHCD(+)
				AND T1.ORGCD = T9.ORGCD(+)
				AND T1.STUDENTNO = T9.STUDENTNO(+)	
				
				AND T1.SURVSEQ = T10.SURVSEQ(+)
				AND 'AG' = T10.SURVKINDCD(+) 
				AND T1.SCHCD = T10.SCHCD(+)
				AND T1.ORGCD = T10.ORGCD(+)
				AND T1.STUDENTNO = T10.STUDENTNO(+)					
								
			<if test="DEPTCD != null">
				AND T1.DEPTCD = #{DEPTCD} 
			</if>
			<if test="DNCD != null">
				AND T1.DNCD = #{DNCD} 
			</if>
			<if test='REGYN == "1"'> 
				AND T8.ATT_IDT_NO IS NOT NULL
			</if>
			<if test='REGYN == "2"'>  
				AND T8.ATT_IDT_NO IS NULL			
			</if>			
			<if test="STUDENTNO != null">
				AND T1.STUDENTNO = #{STUDENTNO} 
			</if>		
			<if test="JOBTYPEGROUPCD != null">
				AND T7.JOBTYPEGROUPCD  = #{JOBTYPEGROUPCD}
			</if>	
			<if test="UNIQUEKEY != null">
				AND T1.UNIQUEKEY = #{UNIQUEKEY} 
			</if>		
			<if test="NAME != null">
				AND T9.NAME = SP_ENC_FU(#{NAME})
			</if>	
		)
		SELECT FNL.* 
		FROM 
			(
			SELECT ROWNUM AS RNUM, F1.* FROM(
				SELECT
					 A.*
					, B1.CDNM AS ORGNM 
					, B2.CDNM AS SCHKINDNM  
					, B4.CDNM AS DNNM 
					, B5.CDNM AS SEXNM 
					, B6.CDNM AS SCHWORKFORMNM 
					, B7.CDNM AS NACODENM 
					, B8.CDNM AS OVERSEAWORKTYPENM 
					, B9.CDNM AS GOORGNM 		
					, B10.CDNM AS JOBTYPENM						
					FROM BASE A, T_CODE B1, T_CODE B2, T_CODE B4, T_CODE B5, T_CODE B6, T_CODE B7, T_CODE B8, T_CODE B9, T_CODE B10
					WHERE '1001' = B1.CDTYPE(+) AND A.ORGCD = B1.CD(+)
						AND '0527' = B2.CDTYPE(+) AND A.SCHKINDCD = B2.CD(+)
						AND '1004' = B4.CDTYPE(+) AND A.DNCD = B4.CD(+)
						AND '0529' = B5.CDTYPE(+) AND A.SEXCD = B5.CD(+)
						AND '2012' = B6.CDTYPE(+) AND A.SCHWORKFORM = B6.CD(+)
						AND '6007' = B7.CDTYPE(+) AND A.NACODE = B7.CD(+)
						AND '2011' = B8.CDTYPE(+) AND A.OVERSEAWORKTYPE = B8.CD(+)
						AND '1001' = B9.CDTYPE(+) AND A.GOORGCD = B9.CD(+)		
						AND '2001' = B10.CDTYPE(+) AND A.JOBTYPECD = B10.CD(+)	
				ORDER BY  A.COLNM,A.DEPTNM,A.DETAILDEPTNM,A.DNCD,A.NAME	
				) F1 	
			where
			    1=1
			    and ( JOBTYPECD <![CDATA[<>]]>'6' or (JOBTYPECD='6' and JOBTYPECD_ORG is null) )				
			) FNL
		WHERE RNUM BETWEEN #{START} AND #{END}			
																				
	</select>
		
	<select id="listEvdocInfoTOTALPAGECNT" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT COUNT(*) TOTALPAGECNT
			FROM TMAG_ATRGRDINFO T1, TMCM_GOSCHOOL T6
				, TMAD_SCHOOL T5,TCCM_JOBCODE T7
				, ( SELECT A.SURVSEQ,A.SURVKINDCD,A.SCHCD,A.ORGCD,A.UNIQUEKEY, A.ATT_IDT_NO,A.ISEVDDOCYN, A.ATT_SEQ
							, B.SAVE_FILE_NAME, B.REAL_FILE_NAME, B.SAVE_PATH  
							,A.PAGENO
							,A.IMPROPTYN
							,A.RTNRN
							,A.EVDDOCETC 
					FROM TMAG_EVDDOC A, TMAD_SURVFILE B
					WHERE A.SURVSEQ = #{SURVSEQ}
					AND A.SURVKINDCD = #{SURVKINDCD}					
					AND A.SCHCD = #{SCHCD}
					AND A.ORGCD = #{ORGCD} 
					AND A.EVDDOCSEQ = 1
					AND A.EVDDOCTYPE = '1'
					AND A.ATT_IDT_NO = B.ATT_IDT_NO(+) 
					AND A.ATT_SEQ = B.ATT_SEQ(+)
				) T8, TMGP_GRDPSNINFO T9
			WHERE
			 	T1.SURVSEQ = #{SURVSEQ}
				AND T1.SURVKINDCD = #{SURVKINDCD}
				AND T1.SCHCD = #{SCHCD}
				AND T1.ORGCD = #{ORGCD}
				AND T1.SURVSEQ = T6.SURVSEQ(+)
				AND T1.SURVKINDCD = T6.SURVKINDCD(+)
				AND T1.GOSCHCD = T6.SCHCD(+)
				AND T1.GOORGCD = T6.ORGCD(+)					
				AND T1.SURVSEQ = T5.SURVSEQ
				AND T1.SURVKINDCD = T5.SURVKINDCD
				AND T1.SCHCD = T5.SCHCD
				AND T1.ORGCD = T5.ORGCD		
				AND T1.SURVSEQ = T7.SURVSEQ(+)
				AND T1.SURVKINDCD = T7.SURVKINDCD(+)		
				AND DECODE(T1.JOBTYPECD,'52','51','4','80','14','81','16','82', T1.JOBTYPECD) = T7.JOBTYPECD(+)
				AND T1.SURVSEQ = T8.SURVSEQ
				AND T1.SURVKINDCD = T8.SURVKINDCD
				AND T1.SCHCD = T8.SCHCD
				AND T1.ORGCD = T8.ORGCD
				AND T1.UNIQUEKEY = T8.UNIQUEKEY
				AND T1.SURVSEQ = T9.SURVSEQ(+)
				AND 'GP' = T9.SURVKINDCD(+) 
				AND T1.SCHCD = T9.SCHCD(+)
				AND T1.ORGCD = T9.ORGCD(+)
				AND T1.STUDENTNO = T9.STUDENTNO(+)		
				
		<if test="DEPTCD != null">
			AND T1.DEPTCD = #{DEPTCD} 
		</if>
		<if test="DNCD != null">
			AND T1.DNCD = #{DNCD} 
		</if>
		<if test='REGYN == "1"'> 
			AND T8.ATT_IDT_NO IS NOT NULL
		</if>
		<if test='REGYN == "2"'>  
			AND T8.ATT_IDT_NO IS NULL			
		</if>		
		<if test="STUDENTNO != null">
			AND T1.STUDENTNO = #{STUDENTNO} 
		</if>		
		<if test="JOBTYPEGROUPCD != null">
			AND T7.JOBTYPEGROUPCD  = #{JOBTYPEGROUPCD}
		</if>	
		<if test="UNIQUEKEY != null">
			AND T1.UNIQUEKEY = #{UNIQUEKEY} 
		</if>	
		<if test="NAME != null">
			AND T9.NAME = SP_ENC_FU(#{NAME})
		</if>																											
	</select>
			
	<select id="selectAttIdtNo" parameterType="java.util.Map" resultType="java.util.Map">		 
		SELECT MAX(ATT_IDT_NO) ATT_IDT_NO, MAX(NVL(EVDDOCSEQ,1)) AS EVDDOCSEQ FROM TMAG_EVDDOC 
			WHERE SURVSEQ = #{SURVSEQ}
			AND SURVKINDCD = #{SURVKINDCD}
			AND SCHCD = #{SCHCD}
			AND ORGCD = #{ORGCD}
			AND EVDDOCTYPE ='1'
			AND REGTYPE = #{REGTYPE}
			AND WORKERID = #{USERID}
	</select>	
	<select id="selectAttIdtNo1" parameterType="java.util.Map" resultType="java.util.Map">		 
		SELECT MAX(ATT_IDT_NO) ATT_IDT_NO, MAX(NVL(EVDDOCSEQ,1)) AS EVDDOCSEQ FROM TMAG_EVDDOC 
			WHERE SURVSEQ = #{SURVSEQ}
			AND SURVKINDCD = #{SURVKINDCD}
			AND SCHCD = #{SCHCD}
			AND ORGCD = #{ORGCD}
			AND EVDDOCTYPE ='1'
			AND REGTYPE = 1
	</select>	

	<select id="selectAttIdtNo2" parameterType="java.util.Map" resultType="java.util.Map">		 
		SELECT MAX(T2.ATT_IDT_NO) ATT_IDT_NO, MAX(NVL(T2.EVDDOCSEQ,1)) AS EVDDOCSEQ 
		FROM
			TMAG_EVDDOC T2,TMAG_ATRGRDINFO T1, TMAD_DEPTUSER T4
		WHERE
			T1.SURVSEQ = #{SURVSEQ}
			AND T1.SURVKINDCD = #{SURVKINDCD}
			AND T1.SCHCD = #{SCHCD}
			AND T1.ORGCD = #{ORGCD}
			AND T1.SURVSEQ = T4.SURVSEQ
			AND T1.SURVKINDCD = T4.SURVKINDCD
			AND T1.SCHCD = T4.SCHCD
			AND T1.ORGCD = T4.ORGCD
			AND T1.COLCD = T4.COLCD
			AND T1.DEPTCD = T4.DEPTCD
			AND T1.DETAILDEPTNM = T4.DETAILDEPTNM
			AND T1.DNCD = T4.DNCD
			AND T1.SURVSEQ = T2.SURVSEQ
			AND T1.SURVKINDCD = T2.SURVKINDCD
			AND T1.SCHCD = T2.SCHCD
			AND T1.ORGCD = T2.ORGCD
			AND T1.UNIQUEKEY = T2.UNIQUEKEY 
			AND T2.EVDDOCTYPE = '1'
			AND T2.EVDDOCSEQ = 1 
			AND T2.REGTYPE ='2'
			AND T4.USERID = #{USERID} 				
	</select>
					
	<select id="selectAttIdtNo3" parameterType="java.util.Map" resultType="java.util.Map">		 
		SELECT MAX(T2.ATT_IDT_NO) ATT_IDT_NO, MAX(NVL(T2.EVDDOCSEQ,1)) AS EVDDOCSEQ 
		FROM
			TMAG_EVDDOC T2,TMAG_ATRGRDINFO T1, TMAD_USERSCHOOL T4
		WHERE
			T1.SURVSEQ = #{SURVSEQ}
			AND T1.SURVKINDCD = #{SURVKINDCD}
			AND T1.SCHCD = #{SCHCD}
			AND T1.ORGCD = #{ORGCD}
			AND T1.SCHCD = T4.SCHCD
			AND T1.ORGCD = T4.ORGCD
			AND T1.SURVSEQ = T2.SURVSEQ
			AND T1.SURVKINDCD = T2.SURVKINDCD
			AND T1.SCHCD = T2.SCHCD
			AND T1.ORGCD = T2.ORGCD
			AND T1.UNIQUEKEY = T2.UNIQUEKEY 
			AND T2.EVDDOCTYPE = '1'
			AND T2.EVDDOCSEQ = 1 
			AND T2.REGTYPE ='2'
			AND T4.USERID = #{USERID} 
	</select>
	
	<select id="listUser" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT 
			'MANAGER' AS USERID
			,'취업담당자' AS USERNM
		FROM DUAL		
		UNION ALL			
		SELECT 
			T2.USERID
			,SP_DEC_FU(T2.USERNM) AS USERNM
		FROM TMAD_DEPTUSER T1, TMAD_USER T2
		WHERE
		 	T1.SURVSEQ = #{SURVSEQ}
			AND T1.SURVKINDCD = #{SURVKINDCD}
			AND T1.SCHCD = #{SCHCD}
			AND T1.ORGCD = #{ORGCD}
			AND T1.USERID = T2.USERID
		GROUP BY T2.USERID ,T2.USERNM
	</select>		
	<select id="listJobcode" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT 
			T1.JOBTYPECD
			,T1.JOBTYPENM
			,T1.JOBTYPEGROUPCD
			,T1.JOBTYPEGROUPNM
			,T1.CHGROUPID
			,T1.USEYN
			,T1.MODIFYYN
			,T1.ORDERSEQ
			,T1.EVDDOCYN
			,T1.FILEFORMNM
		FROM TCCM_JOBCODE T1
		WHERE
		 	T1.SURVSEQ = #{SURVSEQ}
			AND T1.SURVKINDCD = #{SURVKINDCD}
	</select>	
	
	<select id="listJobGroupCd" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT 
			JOBTYPEGROUPCD 
			, JOBTYPEGROUPNM
			, MAX(ORDERSEQ )AS ORDERSEQ 
			, MAX(JOBTYPECD ) AS JOBTYPECD 
			, MAX(CHGROUPID) AS CHGROUPID
		FROM TCCM_JOBCODE 
		WHERE
		 	SURVSEQ = #{SURVSEQ}
			AND SURVKINDCD = #{SURVKINDCD}
		GROUP BY JOBTYPEGROUPCD,JOBTYPEGROUPNM ORDER BY ORDERSEQ , JOBTYPECD			
	</select>	
	
	<select id="listDetailDeptNm" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT 
			T1.DETAILDEPTNM
		FROM TMAG_ATRGRDINFO T1 
		WHERE
		 	T1.SURVSEQ = #{SURVSEQ}
			AND T1.SURVKINDCD = #{SURVKINDCD}
			AND T1.SCHCD = #{SCHCD}
			AND T1.ORGCD = #{ORGCD}
		GROUP BY T1.DETAILDEPTNM		
	</select>		
	<select id="listColcd" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT 
			T1.COLCD, T2.CDNM
		FROM TMAG_ATRGRDINFO T1, TCCM_CODE T2
		WHERE
		 	T1.SURVSEQ = #{SURVSEQ}
			AND T1.SURVKINDCD = #{SURVKINDCD}
			AND T1.SCHCD = #{SCHCD}
			AND T1.ORGCD = #{ORGCD}
			AND T1.SURVSEQ = T2.SURVSEQ
			AND T1.SURVKINDCD = T2.SURVKINDCD
			AND T2.CDTYPE = '0504'
			AND T1.COLCD = T2.CD
		GROUP BY T1.COLCD, T2.CDNM	
	</select>		
	<select id="listDeptcd" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT 
			T1.DEPTCD
			,T3.DEPTNM
		FROM TMAG_ATRGRDINFO T1, TMCM_DEPT T3
		WHERE
		 	T1.SURVSEQ = #{SURVSEQ}
			AND T1.SURVKINDCD = #{SURVKINDCD}
			AND T1.SCHCD = #{SCHCD}
			AND T1.ORGCD = #{ORGCD}	
			AND T1.SURVSEQ = T3.SURVSEQ
			AND T1.SURVKINDCD = T3.SURVKINDCD
			AND T1.DEPTCD = T3.DEPTCD
		GROUP BY T1.DEPTCD,T3.DEPTNM	
	</select>	
	<select id="listDncd" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT 
			T1.DNCD, T2.CDNM
		FROM TMAG_ATRGRDINFO T1, TCCM_CODE T2
		WHERE
		 	T1.SURVSEQ = #{SURVSEQ}
			AND T1.SURVKINDCD = #{SURVKINDCD}
			AND T1.SCHCD = #{SCHCD}
			AND T1.ORGCD = #{ORGCD}
			AND T1.SURVSEQ = T2.SURVSEQ
			AND T1.SURVKINDCD = T2.SURVKINDCD
			AND T2.CDTYPE = '1004'
			AND T1.DNCD = T2.CD
		GROUP BY T1.DNCD, T2.CDNM		
	</select>
			
	<update id="updateAgEvdocOne" parameterType="java.util.Map" flushCache="true">
	    UPDATE TMAG_EVDDOC T1 
	    	SET (ATT_IDT_NO,ATT_SEQ) = (SELECT #{ATT_IDT_NO},ATT_SEQ FROM TMAD_SURVFILE A
	    	 				WHERE A.ATT_IDT_NO = #{ATT_IDT_NO}
	    	 				AND SUBSTR(A.REAL_FILE_NAME ,0,INSTR(A.REAL_FILE_NAME, '.')-1) = T1.UNIQUEKEY )
	    	,WORKERID = #{USERID}
			,WORKDTHM = SYSDATE
	    WHERE T1.SURVSEQ =  #{SURVSEQ}
			AND T1.SURVKINDCD = #{SURVKINDCD}
			AND T1.SCHCD = #{SCHCD}
			AND T1.ORGCD = #{ORGCD}
			AND T1.EVDDOCSEQ = 1
			AND T1.EVDDOCTYPE = '1'
			AND T1.ISEVDDOCYN !='2'
	</update>
			
	<update id="updateAgEvdocAll" parameterType="java.util.Map" flushCache="true">
		UPDATE TMAG_EVDDOC TT1 
	    	SET (ATT_IDT_NO,ATT_SEQ) = (SELECT #{ATT_IDT_NO},T6.ATT_SEQ  
							FROM
								TMAG_EVDDOC T2,TMAG_ATRGRDINFO T1, TCCM_JOBCODE T4,TMAD_SCHOOL T5,TMAD_SURVFILE T6
							WHERE
								T1.SURVSEQ = #{SURVSEQ}
								AND T1.SURVKINDCD = #{SURVKINDCD}
								AND T1.SCHCD = #{SCHCD}
								AND T1.ORGCD = #{ORGCD}
								AND T1.SURVSEQ = T4.SURVSEQ
								AND T1.SURVKINDCD = T4.SURVKINDCD
								AND T1.JOBTYPECD = T4.JOBTYPECD
								AND T1.SURVSEQ = T2.SURVSEQ
								AND T1.SURVKINDCD = T2.SURVKINDCD
								AND T1.SCHCD = T2.SCHCD
								AND T1.ORGCD = T2.ORGCD
								AND T1.UNIQUEKEY = T2.UNIQUEKEY 
								AND T1.SURVSEQ = T5.SURVSEQ
								AND T1.SURVKINDCD = T5.SURVKINDCD
								AND T1.SCHCD = T5.SCHCD
								AND T1.ORGCD = T5.ORGCD	
								AND T2.EVDDOCTYPE = '1' /* 증빙1, 소명 2 */
								AND T2.EVDDOCSEQ = 1    /*  증빙자료는 1  */
								AND T2.REGTYPE ='1'    /*  일괄1, 개별 2  */
								AND T6.ATT_IDT_NO = #{ATT_IDT_NO}
								AND TT1.UNIQUEKEY = T1.UNIQUEKEY
								AND SUBSTR(T6.REAL_FILE_NAME ,0,INSTR(T6.REAL_FILE_NAME, '.')-1) = T1.SURVSEQ ||'_'||T1.SCHCD ||T1.ORGCD||'_'|| T4.FILEFORMNM
								)
			,WORKERID = #{USERID}
			,WORKDTHM = SYSDATE
		WHERE TT1.SURVSEQ =  #{SURVSEQ}
			AND TT1.SURVKINDCD = #{SURVKINDCD}
			AND TT1.SCHCD = #{SCHCD}
			AND TT1.ORGCD = #{ORGCD}
			AND TT1.EVDDOCSEQ = 1
			AND TT1.EVDDOCTYPE = '1'
			AND TT1.ISEVDDOCYN !='2'   /* 증빙자료 미존재 여1,부2	*/
	</update>
	
	<update id="updateGarbage" parameterType="java.util.Map" >
		UPDATE TMAG_EVDDOC TT1 
	    	SET ATT_IDT_NO = NULL, ATT_SEQ = NULL
		WHERE TT1.SURVSEQ =  #{SURVSEQ}
			AND TT1.SURVKINDCD = #{SURVKINDCD}
			AND TT1.SCHCD = #{SCHCD}
			AND TT1.ORGCD = #{ORGCD}
			AND TT1.ATT_IDT_NO = #{ATT_IDT_NO}
			AND TT1.EVDDOCTYPE = '1'
			AND TT1.ATT_SEQ NOT IN ( SELECT T6.ATT_SEQ FROM TMAD_SURVFILE T6 WHERE T6.ATT_IDT_NO = #{ATT_IDT_NO} )
	</update>
				
	<select id="selectSurvFiles" parameterType="java.util.Map" resultType="java.util.Map">
			SELECT 
           		A.ATT_IDT_NO, A.ATT_SEQ, A.SAVE_FILE_NAME, A.REAL_FILE_NAME, A.SAVE_PATH, A.FILE_SIZE
           	FROM TMAD_SURVFILE A
			WHERE A.ATT_IDT_NO = #{ATT_IDT_NO}
			AND A.ATT_SEQ NOT IN ( SELECT T1.ATT_SEQ 
									FROM TMAG_EVDDOC T1 
									WHERE T1.SURVSEQ = #{SURVSEQ} 
									AND T1.SURVKINDCD = #{SURVKINDCD} 
									AND T1.SCHCD = #{SCHCD} 
									AND T1.ORGCD = #{ORGCD} 
									AND T1.ATT_IDT_NO = #{ATT_IDT_NO} )		 
	</select>
					
	<update id="updatePageNo" parameterType="java.util.Map" flushCache="true">
	       UPDATE TMAG_EVDDOC 
	       SET PAGENO = #{PAGENO}
	       		,MODIFIERID = #{WORKERID}
	       		,MODDTHM = SYSDATE
			WHERE SURVSEQ = #{SURVSEQ}
			AND SURVKINDCD = #{SURVKINDCD}
			AND SCHCD = #{SCHCD}
			AND ORGCD = #{ORGCD}
			AND UNIQUEKEY = #{UNIQUEKEY}    
			AND EVDDOCSEQ = #{EVDDOCSEQ}
	</update>		
	
	<update id="updateIsEvddocYn" parameterType="java.util.Map" flushCache="true">
			MERGE INTO TMAG_EVDDOC S
		    USING DUAL 
		       ON (S.SURVSEQ = #{SURVSEQ} AND S.SURVKINDCD = #{SURVKINDCD}
		       		AND S.SCHCD = #{SCHCD} AND S.ORGCD = #{ORGCD}
		       		AND S.UNIQUEKEY = #{UNIQUEKEY} 
		       )
		    WHEN MATCHED THEN
		        UPDATE SET S.ISEVDDOCYN = #{ISEVDDOCYN}
		        			,S.PAGENO = NULL
		        			,S.MODIFIERID = #{WORKERID}
		        			,S.MODDTHM = SYSDATE
		    WHEN NOT MATCHED THEN
		        INSERT (S.SURVSEQ,S.SURVKINDCD,S.SCHCD,S.ORGCD,S.UNIQUEKEY,S.EVDDOCSEQ,S.PAGENO,S.ISEVDDOCYN,S.REGTYPE,S.EVDDOCTYPE,S.IMPROPTYN,S.RTNRN,S.ATT_IDT_NO,S.ATT_SEQ,S.EVDDOCETC,S.WORKERID,S.WORKDTHM) 
		        VALUES (#{SURVSEQ},#{SURVKINDCD},#{SCHCD},#{ORGCD},#{UNIQUEKEY},1,NULL,#{ISEVDDOCYN},'2','1',NULL,NULL,NULL,NULL,NULL,#{WORKERID},SYSDATE )			
	</update>	
		
	<update id="updateIsEvddocYnAll" parameterType="java.util.Map" >
	        UPDATE TMAG_EVDDOC SET ISEVDDOCYN = '2'
		        			,PAGENO = NULL
		        			,MODIFIERID = #{WORKERID}
		        			,MODDTHM = SYSDATE
			WHERE SURVSEQ = #{SURVSEQ} AND SURVKINDCD = #{SURVKINDCD}
		       		AND SCHCD = #{SCHCD} AND ORGCD = #{ORGCD}
		       		AND EVDDOCTYPE = '1'
		       		AND ATT_IDT_NO IS NULL
	</update>	
					
	<select id="selectEvdocFileCnt" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT COUNT(*) AS FILE_MAP_CNT 
		FROM TMAG_ATRGRDINFO T1, TMAG_EVDDOC T2
		WHERE
		 	T1.SURVSEQ = #{SURVSEQ}
			AND T1.SURVKINDCD = #{SURVKINDCD}
			AND T1.SCHCD = #{SCHCD}
			AND T1.ORGCD = #{ORGCD}
			AND T1.SURVSEQ = T2.SURVSEQ
			AND T1.SURVKINDCD = T2.SURVKINDCD
			AND T1.SCHCD = T2.SCHCD
			AND T1.ORGCD = T2.ORGCD
			AND T1.UNIQUEKEY = T2.UNIQUEKEY
			AND T2.ISEVDDOCYN = '1'
			AND T2.EVDDOCTYPE = '1'
			AND T2.ATT_IDT_NO IS NOT NULL
	</select>	
	
	<update id="updateDeptStatus" parameterType="java.util.Map">
			UPDATE TMAD_DEPTUSER SET PRGSTATUSCD = #{STATUSCD},PRGSTATUSDTHM = SYSDATE
							,MODIFIERID = #{WORKERID}
		        			,MODDTHM = SYSDATE
			 WHERE 					 
				SURVSEQ = #{SURVSEQ}
				AND SURVKINDCD = #{SURVKINDCD}
				AND USERID = #{USERID}				
				AND SCHCD = #{SCHCD}
				AND ORGCD = #{ORGCD}
	</update>	

	<select id="chkEvdocOne" parameterType="java.util.Map" resultType="int">
		SELECT COUNT(*) AS CNT 
		FROM TMAG_ATRGRDINFO T1, TMAG_EVDDOC T2, TMAD_DEPTUSER T4
		WHERE
		 	T1.SURVSEQ = #{SURVSEQ}
			AND T1.SURVKINDCD = #{SURVKINDCD}
			AND T1.SCHCD = #{SCHCD}
			AND T1.ORGCD = #{ORGCD}
			AND T1.SURVSEQ = T2.SURVSEQ
			AND T1.SURVKINDCD = T2.SURVKINDCD
			AND T1.SCHCD = T2.SCHCD
			AND T1.ORGCD = T2.ORGCD
			AND T1.UNIQUEKEY = T2.UNIQUEKEY
			AND T2.ISEVDDOCYN = '1'
			AND T2.EVDDOCTYPE = '1'
			AND T2.EVDDOCSEQ = 1
			AND T1.SURVSEQ = T4.SURVSEQ
			AND T1.SURVKINDCD = T4.SURVKINDCD
			AND T1.SCHCD = T4.SCHCD
			AND T1.ORGCD = T4.ORGCD
			AND T1.COLCD = T4.COLCD
			AND T1.DEPTCD = T4.DEPTCD
			AND T1.DETAILDEPTNM = T4.DETAILDEPTNM
			AND T1.DNCD	= T4.DNCD		
			AND T4.USERID = #{USERID}
			AND T2.ATT_IDT_NO IS NULL
	</select>	
	
	<select id="chkEvdocAll" parameterType="java.util.Map" resultType="int">
		SELECT COUNT(*) AS CNT 
		FROM TMAG_EVDDOC T1
		WHERE
		 	T1.SURVSEQ = #{SURVSEQ}
			AND T1.SURVKINDCD = #{SURVKINDCD}
			AND T1.SCHCD = #{SCHCD}
			AND T1.ORGCD = #{ORGCD}
			AND T1.ISEVDDOCYN = '1'
			AND T1.EVDDOCTYPE = '1'
			AND T1.EVDDOCSEQ = 1
			AND T1.ATT_IDT_NO IS NULL
	</select>	
	
	<select id="selectFileAddCount" parameterType="java.util.Map" resultType="int">
		SELECT COUNT(*) AS CNT 
		FROM TMAG_EVDDOC T1
		WHERE
		 	T1.SURVSEQ = #{SURVSEQ}
			AND T1.SURVKINDCD = #{SURVKINDCD}
			AND T1.SCHCD = #{SCHCD}
			AND T1.ORGCD = #{ORGCD}
			AND T1.ATT_IDT_NO = #{ATT_IDT_NO}			
	</select>	
		
	<select id="chkEvdocPageNo" parameterType="java.util.Map" resultType="int">
		SELECT COUNT(*) AS CNT 
		FROM TMAG_EVDDOC T1
		WHERE
		 	T1.SURVSEQ = #{SURVSEQ}
			AND T1.SURVKINDCD = #{SURVKINDCD}
			AND T1.SCHCD = #{SCHCD}
			AND T1.ORGCD = #{ORGCD}
			AND T1.ISEVDDOCYN = '1'
			AND T1.EVDDOCTYPE = '1'
			AND T1.EVDDOCSEQ = 1
			AND T1.REGTYPE = '1'
			AND T1.ATT_IDT_NO IS NOT NULL
			AND T1.PAGENO IS NULL			
	</select>	
	
	<select id="dupfile" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT REAL_FILE_NAME 
		FROM TMAD_SURVFILE  
		WHERE ATT_IDT_NO = #{ATT_IDT_NO} 
		GROUP BY REAL_FILE_NAME
		HAVING COUNT(*) > 1
	</select>
		
	<select id="listEvdocInfoOne" parameterType="java.util.Map" resultType="java.util.Map">
			WITH T_CODE AS (
						SELECT B.SURVSEQ, B.SURVKINDCD, B.CDTYPE, B.CD, B.CDNM	
						FROM TCCM_CODE B
						WHERE SURVSEQ = #{SURVSEQ} AND SURVKINDCD = #{SURVKINDCD}
							AND B.CD != 'GROUPCD' AND B.CDTYPE IN ('1001','1004','0527','0529','2012','6007','2011','2001')
			),BASE AS (	
			SELECT 
				T1.SURVSEQ,T1.SURVKINDCD,T1.SCHKINDCD,T1.SCHCD,T5.SCHNM,T1.ORGCD,T1.COLCD,T1.COLNM
				,T1.DEPTCD,T1.DEPTNM,T1.MOECLASS,T1.DNCD,T1.DETAILDEPTNM,T1.DEGREECD,T1.INYM
				,T1.OUTYM,T1.EXCHANGEYN,T1.STUDENTNO,T1.UNIQUEKEY,T1.BIRTHYEAR,T1.SEXCD,T1.AGE		
				, SP_DEC_FU(T9.NAME) AS NAME  ,T1.JOBTYPECD,T1.WELFARECD,T1.CLERICYN,T1.STARTDT,T1.ENDDT,T1.SCHWORKFORM,T1.WORKHOUR
				,T1.NACODE,T1.FORGCOMNM,T1.OVERSEAVISATYPE,T1.OVERSEAVISAYN,T1.OVERSEAWORKTYPE,T1.SAMEUNIVYN
				,T1.GOSCHCD,T6.SCHNM AS GOSCHNM,T1.GOORGCD,T1.GOFORGSCHNM,T7.JOBTYPEGROUPCD 
				,T7.JOBTYPEGROUPNM ,T1.ARTNM,T1.ARTPL,T1.ARTPO,T1.ALDYEMPLYN,T1.TRANSCLOSEYN,T1.MNTNEMPLYN1
				,T1.MNTNEMPLYN2,T1.MNTNEMPLYN3,T1.MNTNEMPLYN4,T1.TARGETYN,T1.SALARY,T1.INDLGROUPCD,T1.COMTYPE
				,T1.COMSIZE	,T1.WORKERID,T8.PAGENO,T8.IMPROPTYN,T8.RTNRN,T8.EVDDOCETC,T8.ATT_IDT_NO
				,T8.ATT_SEQ,T8.SAVE_FILE_NAME,T8.REAL_FILE_NAME,T8.SAVE_PATH,T8.ISEVDDOCYN,T8.EVDDOCSEQ
			FROM TMAG_ATRGRDINFO T1, TMAD_DEPTUSER T4, TMCM_GOSCHOOL T6
				, TMAD_SCHOOL T5,TCCM_JOBCODE T7
				, ( SELECT A.SURVSEQ,A.SURVKINDCD,A.SCHCD,A.ORGCD,A.UNIQUEKEY, A.ATT_IDT_NO,A.ISEVDDOCYN, A.ATT_SEQ
							, B.SAVE_FILE_NAME, B.REAL_FILE_NAME, B.SAVE_PATH  
							,A.PAGENO
							,A.IMPROPTYN
							,A.RTNRN
							,A.EVDDOCETC
							,A.EVDDOCSEQ
					FROM TMAG_EVDDOC A, TMAD_SURVFILE B
					WHERE A.SURVSEQ = #{SURVSEQ}
					AND A.SURVKINDCD = #{SURVKINDCD}					
					AND A.SCHCD = #{SCHCD}
					AND A.ORGCD = #{ORGCD} 
					AND A.EVDDOCSEQ = 1
					AND A.EVDDOCTYPE = '1'
					AND A.ATT_IDT_NO = B.ATT_IDT_NO(+) 
					AND A.ATT_SEQ = B.ATT_SEQ(+)
				) T8, TMGP_GRDPSNINFO T9
			WHERE
			 	T1.SURVSEQ = #{SURVSEQ}
				AND T1.SURVKINDCD = #{SURVKINDCD}
				AND T1.SCHCD = #{SCHCD}
				AND T1.ORGCD = #{ORGCD}
				AND T1.SURVSEQ = T6.SURVSEQ(+)
				AND T1.SURVKINDCD = T6.SURVKINDCD(+)
				AND T1.GOSCHCD = T6.SCHCD(+)
				AND T1.GOORGCD = T6.ORGCD(+)
				AND T1.SURVSEQ = T4.SURVSEQ(+)
				AND T1.SURVKINDCD = T4.SURVKINDCD(+)
				AND T1.SCHCD = T4.SCHCD(+)
				AND T1.ORGCD = T4.ORGCD(+)
				AND T1.COLCD = T4.COLCD(+)
				AND T1.DEPTCD = T4.DEPTCD(+)
				AND T1.DETAILDEPTNM = T4.DETAILDEPTNM(+)
				AND T1.DNCD = T4.DNCD(+)					
				AND T1.SURVSEQ = T5.SURVSEQ
				AND T1.SURVKINDCD = T5.SURVKINDCD
				AND T1.SCHCD = T5.SCHCD
				AND T1.ORGCD = T5.ORGCD	
				AND T1.SURVSEQ = T7.SURVSEQ(+)
				AND T1.SURVKINDCD = T7.SURVKINDCD(+)
				AND T1.JOBTYPECD NOT IN ('27','4','80','14','81','16','82','70','71','72','33','35','35')
				AND DECODE(T1.JOBTYPECD,'52','51','4','80','14','81','16','82', T1.JOBTYPECD) = T7.JOBTYPECD(+)
				AND T1.SURVSEQ = T8.SURVSEQ
				AND T1.SURVKINDCD = T8.SURVKINDCD
				AND T1.SCHCD = T8.SCHCD
				AND T1.ORGCD = T8.ORGCD
				AND T1.UNIQUEKEY = T8.UNIQUEKEY
				AND T1.SURVSEQ = T9.SURVSEQ(+)
				AND 'GP' = T9.SURVKINDCD(+)
				AND T1.SCHCD = T9.SCHCD(+)
				AND T1.ORGCD = T9.ORGCD(+)
				AND T1.STUDENTNO = T9.STUDENTNO(+)	
				
			<if test='USERID != "MANAGER"'> 
				AND T4.USERID = #{USERID} 
			</if>				
			<if test='REGYN == "1"'> 
				AND T8.ATT_IDT_NO IS NOT NULL
			</if>
			<if test='REGYN == "2"'>  
				AND T8.ATT_IDT_NO IS NULL			
			</if>			
			<if test="DEPTCD != null">
				AND T1.DEPTCD = #{DEPTCD} 
			</if>
			<if test="DNCD != null">
				AND T1.DNCD = #{DNCD} 
			</if>
			<if test="STUDENTNO != null">
				AND T1.STUDENTNO = #{STUDENTNO} 
			</if>		
			<if test="JOBTYPEGROUPCD != null">
				AND T7.JOBTYPEGROUPCD  = #{JOBTYPEGROUPCD}
			</if>	
			<if test="UNIQUEKEY != null">
				AND T1.UNIQUEKEY = #{UNIQUEKEY} 
			</if>	
			<if test="NAME != null">
				AND T9.NAME = SP_ENC_FU(#{NAME})
			</if>					
		)
		SELECT FNL.*  
		FROM 
			(
			SELECT ROWNUM AS RNUM, F1.* FROM(
				SELECT
				 A.*
				, B1.CDNM AS ORGNM 
				, B2.CDNM AS SCHKINDNM  
				, B4.CDNM AS DNNM 
				, B5.CDNM AS SEXNM 
				, B6.CDNM AS SCHWORKFORMNM 
				, B7.CDNM AS NACODENM 
				, B8.CDNM AS OVERSEAWORKTYPENM 
				, B9.CDNM AS GOORGNM 	
				, B10.CDNM AS JOBTYPENM		
				FROM BASE A, T_CODE B1, T_CODE B2, T_CODE B4, T_CODE B5, T_CODE B6, T_CODE B7, T_CODE B8, T_CODE B9, T_CODE B10
				WHERE '1001' = B1.CDTYPE(+) AND A.ORGCD = B1.CD(+)
					AND '0527' = B2.CDTYPE(+) AND A.SCHKINDCD = B2.CD(+)
					AND '1004' = B4.CDTYPE(+) AND A.DNCD = B4.CD(+)
					AND '0529' = B5.CDTYPE(+) AND A.SEXCD = B5.CD(+)
					AND '2012' = B6.CDTYPE(+) AND A.SCHWORKFORM = B6.CD(+)
					AND '6007' = B7.CDTYPE(+) AND A.NACODE = B7.CD(+)
					AND '2011' = B8.CDTYPE(+) AND A.OVERSEAWORKTYPE = B8.CD(+)
					AND '1001' = B9.CDTYPE(+) AND A.GOORGCD = B9.CD(+)		
					AND '2001' = B10.CDTYPE(+) AND A.JOBTYPECD = B10.CD(+)	
				ORDER BY  A.COLNM,A.DEPTNM,A.DETAILDEPTNM,A.DNCD,A.NAME	
				) F1
			) FNL
		WHERE RNUM BETWEEN #{START} AND #{END}																							
	</select>
		
	<select id="listEvdocInfoOneTOTALPAGECNT" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT COUNT(*) TOTALPAGECNT
			FROM TMAG_ATRGRDINFO T1, TMAD_DEPTUSER T4, TMCM_GOSCHOOL T6
				, TMAD_SCHOOL T5,TCCM_JOBCODE T7
				, ( SELECT A.SURVSEQ,A.SURVKINDCD,A.SCHCD,A.ORGCD,A.UNIQUEKEY, A.ATT_IDT_NO,A.ISEVDDOCYN, A.ATT_SEQ
							, B.SAVE_FILE_NAME, B.REAL_FILE_NAME, B.SAVE_PATH  
							,A.PAGENO
							,A.IMPROPTYN
							,A.RTNRN
							,A.EVDDOCETC
							,A.EVDDOCSEQ
					FROM TMAG_EVDDOC A, TMAD_SURVFILE B
					WHERE A.SURVSEQ = #{SURVSEQ}
					AND A.SURVKINDCD = #{SURVKINDCD}					
					AND A.SCHCD = #{SCHCD}
					AND A.ORGCD = #{ORGCD} 
					AND A.EVDDOCSEQ = 1
					AND A.EVDDOCTYPE = '1'
					AND A.ATT_IDT_NO = B.ATT_IDT_NO(+) 
					AND A.ATT_SEQ = B.ATT_SEQ(+)
				) T8, TMGP_GRDPSNINFO T9
			WHERE
			 	T1.SURVSEQ = #{SURVSEQ}
				AND T1.SURVKINDCD = #{SURVKINDCD}
				AND T1.SCHCD = #{SCHCD}
				AND T1.ORGCD = #{ORGCD}
				AND T1.SURVSEQ = T6.SURVSEQ(+)
				AND T1.SURVKINDCD = T6.SURVKINDCD(+)
				AND T1.GOSCHCD = T6.SCHCD(+)
				AND T1.GOORGCD = T6.ORGCD(+)
				AND T1.SURVSEQ = T4.SURVSEQ(+)
				AND T1.SURVKINDCD = T4.SURVKINDCD(+)
				AND T1.SCHCD = T4.SCHCD(+)
				AND T1.ORGCD = T4.ORGCD(+)
				AND T1.COLCD = T4.COLCD(+)
				AND T1.DEPTCD = T4.DEPTCD(+)
				AND T1.DETAILDEPTNM = T4.DETAILDEPTNM(+)
				AND T1.DNCD = T4.DNCD(+)					
				AND T1.SURVSEQ = T5.SURVSEQ
				AND T1.SURVKINDCD = T5.SURVKINDCD
				AND T1.SCHCD = T5.SCHCD
				AND T1.ORGCD = T5.ORGCD	
				AND T1.SURVSEQ = T7.SURVSEQ(+)
				AND T1.SURVKINDCD = T7.SURVKINDCD(+)	
				AND DECODE(T1.JOBTYPECD,'52','51','4','80','14','81','16','82', T1.JOBTYPECD) = T7.JOBTYPECD(+)
				AND T1.SURVSEQ = T8.SURVSEQ
				AND T1.SURVKINDCD = T8.SURVKINDCD
				AND T1.SCHCD = T8.SCHCD
				AND T1.ORGCD = T8.ORGCD
				AND T1.UNIQUEKEY = T8.UNIQUEKEY
				AND T1.SURVSEQ = T9.SURVSEQ(+)
				AND 'GP' = T9.SURVKINDCD(+)
				AND T1.SCHCD = T9.SCHCD(+)
				AND T1.ORGCD = T9.ORGCD(+)
				AND T1.STUDENTNO = T9.STUDENTNO(+)	
				
			<if test='USERID != "MANAGER"'> 
				AND T4.USERID = #{USERID} 
			</if>				
			<if test='REGYN == "1"'> 
				AND T8.ATT_IDT_NO IS NOT NULL
			</if>
			<if test='REGYN == "2"'>  
				AND T8.ATT_IDT_NO IS NULL			
			</if>			
			<if test="DEPTCD != null">
				AND T1.DEPTCD = #{DEPTCD} 
			</if>
			<if test="DNCD != null">
				AND T1.DNCD = #{DNCD} 
			</if>
			<if test="STUDENTNO != null">
				AND T1.STUDENTNO = #{STUDENTNO} 
			</if>		
			<if test="JOBTYPEGROUPCD != null">
				AND T7.JOBTYPEGROUPCD  = #{JOBTYPEGROUPCD}
			</if>	
			<if test="UNIQUEKEY != null">
				AND T1.UNIQUEKEY = #{UNIQUEKEY} 
			</if>	
			<if test="NAME != null">
				AND T9.NAME = SP_ENC_FU(#{NAME})
			</if>																							
	</select>	
	
	<insert id="updateMntr" parameterType="java.util.Map" >
		<selectKey resultType="int" keyProperty="seq" order="BEFORE">
	        SELECT NVL(MAX(MNTRSEQ),0)+1 FROM TMAD_SURVMNTR  WHERE SURVSEQ = #{SURVSEQ} AND SURVKINDCD =  #{SURVKINDCD} AND SCHCD = #{SCHCD} AND ORGCD =  #{ORGCD}       
	    </selectKey> 		
			MERGE INTO TMAD_SURVMNTR S
		    USING DUAL 
		       ON (S.SURVSEQ = #{SURVSEQ} AND S.SURVKINDCD = #{SURVKINDCD}
		       		AND S.SCHCD = #{SCHCD} AND S.ORGCD = #{ORGCD}
		       		AND S.STATUSCD = #{STATUSCD} 
		       )
		    WHEN MATCHED THEN
		        UPDATE SET S.WORKERID = #{WORKERID}
		    WHEN NOT MATCHED THEN
		        INSERT (S.SURVSEQ,S.SURVKINDCD,S.SCHCD,S.ORGCD,S.MNTRSEQ,S.STATUSCD,S.STATUSWKDTHM,S.RCEPTCN,S.ATT_IDT_NO,S.ATT_SEQ,S.WORKERID,S.WORKDTHM) 
		        VALUES (#{SURVSEQ},#{SURVKINDCD},#{SCHCD},#{ORGCD},#{seq},#{STATUSCD},SYSDATE,NULL,NULL,NULL,#{WORKERID},SYSDATE)			
	</insert>	
		    
	<delete id="deleteRstTable" parameterType="java.util.Map">
		DELETE FROM TMAG_ATRGRDRST T1		
		WHERE
		 	T1.SURVSEQ = #{SURVSEQ}
			AND T1.SURVKINDCD = #{SURVKINDCD}
			AND T1.SCHCD = #{SCHCD}
			AND T1.ORGCD = #{ORGCD}		
	</delete>	
			
	<delete id="deleteInfoTable" parameterType="java.util.Map">
		DELETE FROM TMAG_ATRGRDINFO T1		
		WHERE
		 	T1.SURVSEQ = #{SURVSEQ}
			AND T1.SURVKINDCD = #{SURVKINDCD}
			AND T1.SCHCD = #{SCHCD}
			AND T1.ORGCD = #{ORGCD}		
	</delete>	
				    
	<insert id="insertRstTable" parameterType="java.util.Map">
		INSERT INTO TMAG_ATRGRDRST (
			SURVSEQ
			,SURVKINDCD
			,SCHKINDCD
			,SCHCD
			,ORGCD
			,COLCD
			,COLNM
			,DEPTCD
			,MOECLASS
			,DEPTNM
			,DNCD
			,DETAILDEPTNM
			,DEGREECD
			,INYM
			,OUTYM
			,EXCHANGEYN
			,STUDENTNO
			,UNIQUEKEY
			,BIRTHYEAR
			,SEXCD
			,AGE
			,JOBTYPECD
			,WELFARECD
			,CLERICYN
			,STARTDT
			,ENDDT
			,SCHWORKFORM
			,WORKHOUR
			,NACODE
			,FORGCOMNM
			,OVERSEAVISATYPE
			,OVERSEAVISAYN
			,OVERSEAWORKTYPE
			,SAMEUNIVYN
			,GOSCHCD
			,GOORGCD
			,GOFORGSCHNM
			,ARTNM
			,ARTPL
			,ARTPO
			,ALDYEMPLYN
			,TRANSCLOSEYN
			,MNTNEMPLYN1
			,MNTNEMPLYN2
			,MNTNEMPLYN3
			,MNTNEMPLYN4
			,TARGETYN
			,SALARY
			,INDLGROUPCD
			,COMTYPE
			,COMSIZE
			,WORKERID
			,WORKDTHM
			) SELECT 
			T1.SURVSEQ
			,T1.SURVKINDCD
			,T1.SCHKINDCD
			,T1.SCHCD
			,T1.ORGCD
			,T1.COLCD
			,T1.COLNM
			,T1.DEPTCD
			,T1.MOECLASS
			,T1.DEPTNM
			,T1.DNCD
			,T1.DETAILDEPTNM
			,T1.DEGREECD
			,T1.INYM
			,T1.OUTYM
			,T1.EXCHANGEYN
			,T1.STUDENTNO
			,T1.UNIQUEKEY
			,T1.BIRTHYEAR
			,T1.SEXCD
			,T1.AGE
			,T1.JOBTYPECD
			,T1.WELFARECD
			,T1.CLERICYN
			,T1.STARTDT
			,T1.ENDDT
			,T1.SCHWORKFORM
			,T1.WORKHOUR
			,T1.NACODE
			,T1.FORGCOMNM
			,T1.OVERSEAVISATYPE
			,T1.OVERSEAVISAYN
			,T1.OVERSEAWORKTYPE
			,T1.SAMEUNIVYN
			,T1.GOSCHCD
			,T1.GOORGCD
			,T1.GOFORGSCHNM
			,T1.ARTNM
			,T1.ARTPL
			,T1.ARTPO
			,T1.ALDYEMPLYN
			,T1.TRANSCLOSEYN
			,T1.MNTNEMPLYN1
			,T1.MNTNEMPLYN2
			,T1.MNTNEMPLYN3
			,T1.MNTNEMPLYN4
			,T1.TARGETYN
			,T1.SALARY
			,T1.INDLGROUPCD
			,T1.COMTYPE
			,T1.COMSIZE
			,T1.WORKERID
			,T1.WORKDTHM
		FROM TMAG_ATRGRDINFO T1		
		WHERE
		 	T1.SURVSEQ = #{SURVSEQ}
			AND T1.SURVKINDCD = #{SURVKINDCD}
			AND T1.SCHCD = #{SCHCD}
			AND T1.ORGCD = #{ORGCD}		
	</insert>	
			    
</mapper>