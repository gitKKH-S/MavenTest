<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="AdProgressGpResultMapper">
	
	<select id="selectSurvList" resultType="java.util.Map">
		SELECT SURVSEQ, SURVKINDCD, SURVYEAR, TO_CHAR(TO_DATE(SURVSTRTDT, 'YYYY.MM.DD'), 'YYYY.MM.DD') AS SURVSTRTDT, TO_CHAR(TO_DATE(SURVENDDT, 'YYYY.MM.DD'), 'YYYY.MM.DD') AS SURVENDDT, SURVOBJ, SURVNM
		FROM TMAD_SURVEY
		WHERE SURVKINDCD = 'GP'
		ORDER BY SURVYEAR DESC, SURVENDDT DESC
	</select>
	
	<select id="searchGpResultCnt" parameterType="java.util.Map" resultType="java.util.Map">
		WITH T_SURVEY AS (		/* 조사 기본정보*/
			SELECT SURVSEQ, SURVKINDCD, SURVYEAR, SURVSTRTDT, SURVENDDT, SURVOBJ, SURVNM, REMARK, SURVSTATUSCD, WORKERID, WORKDTHM 
			FROM TMAD_SURVEY 
			WHERE SURVYEAR = #{SURVYEAR} AND SURVKINDCD = 'GP'	
		
		), T_TMAD_SCHOOL AS ( 	/* 조사대상학교*/
			SELECT A.*
			FROM TMAD_SCHOOL A
				RIGHT OUTER JOIN T_SURVEY B ON A.SURVSEQ = B.SURVSEQ AND A.SURVKINDCD = B.SURVKINDCD 
			WHERE A.SURVKINDCD = 'GP' 
				AND A.SURVPROSTATUSCD IN ('1','2','3','4','5','6')	
			ORDER BY SCHNM
		)		
		SELECT COUNT(*) AS CNT  FROM T_TMAD_SCHOOL A					
		<where>			 
			<if test=' SCHKINDCD != "" and SCHKINDCD != null '>
				AND A.SCHKINDCD = #{SCHKINDCD}
			</if>
			<if test=' SCHNM != "" and SCHNM != null '>
				AND A.SCHNM LIKE '%' || #{SCHNM} || '%'
			</if>
			<if test=' SURVPROSTATUSCD != "" and SURVPROSTATUSCD != null '>
				AND A.SURVPROSTATUSCD = #{SURVPROSTATUSCD}
			</if>
		</where>			
	</select>	
	
	
	<select id="searchGpResultList" parameterType="java.util.Map" resultType="java.util.Map">		
		WITH T_SURVEY AS (		/* 조사 기본정보*/
			SELECT SURVSEQ, SURVKINDCD, SURVYEAR, SURVSTRTDT, SURVENDDT, SURVOBJ, SURVNM, REMARK, SURVSTATUSCD, WORKERID, WORKDTHM 
			FROM TMAD_SURVEY 
			WHERE SURVYEAR = #{SURVYEAR} AND SURVKINDCD = 'GP'	
		
		), T_TMAD_SCHOOL AS ( 	/* 조사대상학교*/
			SELECT A.*
			FROM TMAD_SCHOOL A
				RIGHT OUTER JOIN T_SURVEY B ON A.SURVSEQ = B.SURVSEQ AND A.SURVKINDCD = B.SURVKINDCD 
			WHERE A.SURVKINDCD = 'GP' 
				AND A.SURVPROSTATUSCD IN ('1','2','3','4','5','6')	
			ORDER BY SCHNM
		), T_SURVMNTR AS (		/* 상태진행현황 */	
			SELECT 
				BB.SURVSEQ, BB.SURVKINDCD, BB.SCHCD, BB.ORGCD, BB.MNTRSEQ, BB.STATUSCD, BB.STATUSWKDTHM, BB.RCEPTCN, BB.ATT_IDT_NO, BB.ATT_SEQ			
			FROM T_SURVEY AA
				LEFT OUTER JOIN TMAD_SURVMNTR BB ON AA.SURVSEQ = BB.SURVSEQ AND AA.SURVKINDCD = BB.SURVKINDCD /* AND STATUSCD = '2' 수정요청건 정보만  */
			ORDER BY BB.STATUSWKDTHM DESC
		)
		
		SELECT * FROM (
			SELECT ROWNUM AS RNUM, A.* FROM (
				SELECT 
					'false' AS CHK
					, A.SURVSEQ		/* 조사기준*/
					, A.SURVKINDCD
					, A.SCHCD
					, A.ORGCD			/* 본분교 코드 */
					, SP_CODENAME_FU(A.SURVSEQ, A.SURVKINDCD, '1001', A.ORGCD) AS ORGNM
			
					, A.SCHNM			/* 학교명 */
					, A.UNIGRADECD		/* 대학 / 대학원코드*/
					, A.SCHKINDCD		/* 학교 종류 코드*/
					, SP_CODENAME_FU(A.SURVSEQ, A.SURVKINDCD, '0527', A.SCHKINDCD) AS SCHKINDNM
					
					, A.SCHFUNDCD
					, A.SCHSEXCD
					, A.SCHDNCD
					, A.SCHSTATCD		/* 학교 상태코드 */
					, A.PROVINCECD
					, A.ZIPCODE
					, A.SCHADDR
					, A.SURVTARGETYN
					, A.SURVPROSTATUSCD		/* 조사진행 상태 */
					, SP_CODENAME_FU(A.SURVSEQ, A.SURVKINDCD, '0081', A.SURVPROSTATUSCD) AS SURVPROSTATUSNM
					
					, TO_CHAR(A.SURVPROSTATUSDTHM, 'YYYY.MM.DD HH24:MI') AS SURVPROSTATUSDTHM /* 상태수정일 */
					, A.SURVSTRTDT			/* 조사시작일 */
					, A.SURVENDDT			/* 조사종료일 */
					
					, C.DEPTCNT
					, DECODE(A.SCHKINDCD, 'M', (C.MSTGRADCNT+C.DRGRADCNT), C.GPCNT) AS GPCNT
					, (
						SELECT RCEPTCN FROM T_SURVMNTR 
						WHERE SCHCD = A.SCHCD AND ORGCD = A.ORGCD AND ROWNUM = 1
					) AS RCEPTCN
				
				FROM T_TMAD_SCHOOL A
					LEFT OUTER JOIN T_SURVEY B ON A.SURVSEQ = B.SURVSEQ AND A.SURVKINDCD = B.SURVKINDCD	
					LEFT OUTER JOIN (
						SELECT 
							SURVSEQ, SURVKINDCD, SCHCD, ORGCD
							, COUNT(DEPTCD) AS DEPTCNT,  SUM(GRADCNT) AS GPCNT, SUM(MSTGRADCNT) AS MSTGRADCNT, SUM(DRGRADCNT) AS DRGRADCNT
						FROM TMGP_GRDPSNCNT GROUP BY SURVSEQ, SURVKINDCD, SCHCD, ORGCD	
					) C ON A.SURVSEQ = C.SURVSEQ AND A.SURVKINDCD = C.SURVKINDCD AND A.SCHCD = C.SCHCD AND A.ORGCD = C.ORGCD					
				<where>			 
					<if test=' SCHKINDCD != "" and SCHKINDCD != null '>
						AND A.SCHKINDCD = #{SCHKINDCD}
					</if>
					<if test=' SCHNM != "" and SCHNM != null '>
						AND A.SCHNM LIKE '%' || #{SCHNM} || '%'
					</if>
					<if test=' SURVPROSTATUSCD != "" and SURVPROSTATUSCD != null '>
						AND A.SURVPROSTATUSCD = #{SURVPROSTATUSCD}
					</if>					
				</where>
				ORDER BY A.SCHNM
				) A
			)
		WHERE RNUM BETWEEN #{START} AND #{END}	
	</select>
		
	<select id="selectDetailGP" parameterType="java.util.Map" resultType="java.util.Map">		
		WITH T_SURVMNTR AS (
			SELECT 
				SURVSEQ, SURVKINDCD, SCHCD, ORGCD, MNTRSEQ, STATUSCD, STATUSWKDTHM, RCEPTCN
			FROM TMAD_SURVMNTR
			WHERE STATUSCD = '4'				
				AND SURVSEQ = #{SURVSEQ} AND SURVKINDCD = #{SURVKINDCD} AND SCHCD = #{SCHCD} AND ORGCD = #{ORGCD}
			ORDER BY STATUSWKDTHM DESC
		)		
		SELECT
			SURVSEQ, SURVKINDCD, SCHCD, ORGCD
			, COLCD, COLNM
			, DEPTCD, DEPTNM
			, DEPTDNCD, SP_CODENAME_FU(SURVSEQ, SURVKINDCD, '1004', DEPTDNCD) AS DEPTDNNM
			, MOECLASS
			, GRADCNT, GRADCNTF, GRADCNTM
			, MSTGRADCNT, MSTGRADCNTF, MSTGRADCNTM
			, DRGRADCNT, DRGRADCNTF, DRGRADCNTM
			, GRADCNT2, GRADCNTF2, GRADCNTM2
			, MSTGRADCNT2, MSTGRADCNTF2, MSTGRADCNTM2
			, DRGRADCNT2, DRGRADCNTF2, DRGRADCNTM2
			, GRADCNT8, GRADCNTF8, GRADCNTM8
			, MSTGRADCNT8, MSTGRADCNTF8, MSTGRADCNTM8
			, DRGRADCNT8, DRGRADCNTF8, DRGRADCNTM8
			, (SELECT TO_CHAR(STATUSWKDTHM, 'YYYY.MM.DD') FROM T_SURVMNTR WHERE ROWNUM = 1) AS STATUSWKDTHM
		FROM TMGP_GRDPSNCNT A
		WHERE A.SURVSEQ = #{SURVSEQ} 
			AND A.SURVKINDCD = #{SURVKINDCD}
			AND A.SCHCD = #{SCHCD}
			AND A.ORGCD = #{ORGCD}
		ORDER BY A.COLNM, A.DEPTNM, A.DEPTDNCD
	</select>
	
	<select id="overlapChk" parameterType="java.util.Map" resultType="java.lang.Integer">
		SELECT COUNT(DEPTCD)
		FROM TMCM_DEPT
		WHERE SURVSEQ = #{SURVSEQ}
			AND SURVKINDCD = #{SURVKINDCD}
			AND DEPTCD = #{DEPTCD}				
	</select>
	
	
	<insert id="insertDetailGP">
		INSERT INTO TMGP_GRDPSNCNT (
			SURVSEQ, SURVKINDCD, SCHCD, ORGCD, COLCD, COLNM, DEPTCD, DEPTNM, DEPTDNCD, MOECLASS
			, GRADCNT, GRADCNTF, GRADCNTM
			, MSTGRADCNT, MSTGRADCNTF, MSTGRADCNTM
			, DRGRADCNT, DRGRADCNTF, DRGRADCNTM
			, GRADCNT2, GRADCNTF2, GRADCNTM2
			, MSTGRADCNT2, MSTGRADCNTF2, MSTGRADCNTM2
			, DRGRADCNT2, DRGRADCNTF2, DRGRADCNTM2
			, GRADCNT8, GRADCNTF8, GRADCNTM8
			, MSTGRADCNT8, MSTGRADCNTF8, MSTGRADCNTM8
			, DRGRADCNT8, DRGRADCNTF8, DRGRADCNTM8
			, WORKERID, WORKDTHM, MODIFIERID, MODDTHM
		) VALUES (
			#{SURVSEQ}, #{SURVKINDCD}, #{SCHCD}, #{ORGCD}, #{COLCD}
			, NVL(#{COLNM}, ' ')
			, #{DEPTCD}, NVL(#{DEPTNM},' ')
			, #{DEPTDNCD}, #{MOECLASS}
			, #{GRADCNT}, 		#{GRADCNTF}, 	#{GRADCNTM}
			, NVL(#{MSTGRADCNT2}, 0) + NVL(#{MSTGRADCNT8}, 0),	NVL(#{MSTGRADCNTF2}, 0) + NVL(#{MSTGRADCNTF8}, 0),	NVL(#{MSTGRADCNTM2}, 0) + NVL(#{MSTGRADCNTM8}, 0)
			, NVL(#{DRGRADCNT2}, 0) + NVL(#{DRGRADCNT8}, 0), 	NVL(#{DRGRADCNTF2}, 0) + NVL(#{DRGRADCNTF8}, 0), 	NVL(#{DRGRADCNTM2}, 0) + NVL(#{DRGRADCNTM8}, 0)
			, #{GRADCNT2}, 		#{GRADCNTF2}, 	#{GRADCNTM2}
			, #{MSTGRADCNT2}, 	#{MSTGRADCNTF2},#{MSTGRADCNTM2}
			, #{DRGRADCNT2}, 	#{DRGRADCNTF2}, #{DRGRADCNTM2}
			, #{GRADCNT8}, 		#{GRADCNTF8}, 	#{GRADCNTM8}
			, #{MSTGRADCNT8}, 	#{MSTGRADCNTF8},#{MSTGRADCNTM8}
			, #{DRGRADCNT8}, 	#{DRGRADCNTF8}, #{DRGRADCNTM8} 
			, #{WORKERID}, SYSDATE, #{MODIFIERID}, SYSDATE
		)
	</insert>
	
		
	<update id="updateDetailGP">
		UPDATE TMGP_GRDPSNCNT
		SET		    
			COLNM        = NVL(#{COLNM}, ' ') 
			, DEPTNM       = NVL(#{DEPTNM},' ')
			, GRADCNT      = NVL(#{GRADCNT}, 0) 
		    , GRADCNTF     = NVL(#{GRADCNTF}, 0) 
		    , GRADCNTM     = NVL(#{GRADCNTM}, 0) 
		    
		    , MSTGRADCNT   =  NVL(#{MSTGRADCNT2}, 0) + NVL(#{MSTGRADCNT8}, 0)
		    , MSTGRADCNTF  =  NVL(#{MSTGRADCNTF2}, 0) + NVL(#{MSTGRADCNTF8}, 0)
		    , MSTGRADCNTM  =  NVL(#{MSTGRADCNTM2}, 0) + NVL(#{MSTGRADCNTM8}, 0)
		    
		    , DRGRADCNT    =  NVL(#{DRGRADCNT2}, 0) + NVL(#{DRGRADCNT8}, 0)
		    , DRGRADCNTF   =  NVL(#{DRGRADCNTF2}, 0) + NVL(#{DRGRADCNTF8}, 0)
		    , DRGRADCNTM   =  NVL(#{DRGRADCNTM2}, 0) + NVL(#{DRGRADCNTM8}, 0)
		    
		    , GRADCNT2     = NVL(#{GRADCNT2}, 0) 
		    , GRADCNTF2    = NVL(#{GRADCNTF2}, 0) 
		    , GRADCNTM2    = NVL(#{GRADCNTM2}, 0)
		     
		    , MSTGRADCNT2  = NVL(#{MSTGRADCNT2}, 0) 
		    , MSTGRADCNTF2 = NVL(#{MSTGRADCNTF2}, 0) 
		    , MSTGRADCNTM2 = NVL(#{MSTGRADCNTM2}, 0) 
		    
		    , DRGRADCNT2   = NVL(#{DRGRADCNT2}, 0) 
		    , DRGRADCNTF2  = NVL(#{DRGRADCNTF2}, 0) 
		    , DRGRADCNTM2  = NVL(#{DRGRADCNTM2}, 0) 
		    
		    
		    , GRADCNT8     = NVL(#{GRADCNT8}, 0) 
		    , GRADCNTF8    = NVL(#{GRADCNTF8}, 0) 
		    , GRADCNTM8    = NVL(#{GRADCNTM8}, 0)
		     
		    , MSTGRADCNT8  = NVL(#{MSTGRADCNT8}, 0) 
		    , MSTGRADCNTF8 = NVL(#{MSTGRADCNTF8}, 0) 
		    , MSTGRADCNTM8 = NVL(#{MSTGRADCNTM8}, 0)
		     
		    , DRGRADCNT8   = NVL(#{DRGRADCNT8}, 0) 
		    , DRGRADCNTF8  = NVL(#{DRGRADCNTF8}, 0) 
		    , DRGRADCNTM8  = NVL(#{DRGRADCNTM8}, 0)  
		    		    
		    , MODIFIERID   = #{MODIFIERID} 
		    , MODDTHM      = SYSDATE
		WHERE 
			SURVSEQ      	= #{SURVSEQ} 
		    AND SURVKINDCD  = #{SURVKINDCD}
		    AND SCHCD       = #{SCHCD}
		    AND ORGCD       = #{ORGCD}
		    AND COLCD       = #{COLCD}
		    AND DEPTCD      = #{DEPTCD}
		    AND DEPTDNCD    = #{DEPTDNCD}
		    AND MOECLASS    = #{MOECLASS}	
	</update>
	
	
	<delete id="deleteDetailGP">
		DELETE 
		FROM TMGP_GRDPSNCNT
		WHERE SURVSEQ      	= #{SURVSEQ} 
		    AND SURVKINDCD  = #{SURVKINDCD}
		    AND SCHCD       = #{SCHCD}
		    AND ORGCD       = #{ORGCD}
		    AND COLCD       = #{COLCD}
		    AND DEPTCD      = #{DEPTCD}
		    AND DEPTDNCD    = #{DEPTDNCD}
		    AND MOECLASS    = #{MOECLASS}	
	</delete>
	
</mapper>